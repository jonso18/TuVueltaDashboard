
<mat-form-field *ngIf="Clientes else loading">
  <mat-select placeholder="Seleccione Cliente" [(ngModel)]="selectedCliente" (selectionChange)="onSelectedClient($event)">
    <mat-option *ngFor="let Cliente of Clientes" [value]="Cliente">
      {{Cliente.Nombres + ' ' + Cliente.Apellidos}}
    </mat-option>
  </mat-select>
</mat-form-field>

<ng-template #loading>
  <div class="text-center">
    <mat-spinner></mat-spinner>
    <h3>Cargando Información <small>Por favor, espere...</small></h3>
  </div>
</ng-template>

<mat-form-field *ngIf="Ciudades && selectedCliente">
  <mat-select placeholder="Seleccione la Ciudad" [(ngModel)]="selectedCity" (selectionChange)="onSelectedCity($event)">
    <mat-option *ngFor="let city of Ciudades" [value]="city">
      {{city.Nombre}}
    </mat-option>
  </mat-select>
</mat-form-field>

<div *ngIf="selectedCity; else noSelectedCity" class="global-container">
  <ng-container *ngIf="selectedCity.Coordenadas; else noCoordenadas">
    <ng-container *ngIf="TarifasMensajeria || TarifasMensajeriaCustom; else noTarifas">
      <div class="container-map">
        <agm-map [latitude]="selectedCity.Coordenadas.Lat" [longitude]="selectedCity.Coordenadas.Lng" [zoom]="14" (mapClick)="onMapClick($event)">
          <!-- mapDblClick -->
          <ng-container *ngFor="let marker of puntosIntermedios.value; let i=index">
            <agm-marker *ngIf="marker.Coordenadas" [latitude]="marker.Coordenadas.Lat" [longitude]="marker.Coordenadas.Lng">
              <agm-info-window>Punto {{i + 1 }}</agm-info-window>
            </agm-marker>
          </ng-container>
          <agm-polyline [editable]="true" [strokeColor]="blue" *ngIf="stepper.selectedIndex <= 1; else direction">
            <ng-container *ngFor="let marker of  puntosIntermedios.value">
              <agm-polyline-point *ngIf="marker.Coordenadas" [latitude]="marker.Coordenadas.Lat" [longitude]="marker.Coordenadas.Lng"></agm-polyline-point>
            </ng-container>
          </agm-polyline>
          <ng-template #direction>
            <agm-polyline [editable]="true" [strokeColor]="blue">
              <ng-container *ngFor="let point of  Directions">
                <agm-polyline-point [latitude]="point.lat" [longitude]="point.lng"></agm-polyline-point>
              </ng-container>
            </agm-polyline>
          </ng-template>
        </agm-map>
      </div>
      <div class="mensajeria-form">
        <div class="row">
          <div class="col-sm-offset-1 col-sm-10">
            <mat-card class="card-summary">
              <mat-horizontal-stepper (selectionChange)="onSelectionChange($event)" class="step-container" [linear]="true" #stepper="matHorizontalStepper">

                <!-- Solicitud -->
                <mat-step [stepControl]="form" [editable]="isStepEditable">

                  <form [formGroup]="form">
                    <ng-template matStepLabel>Recorrido</ng-template>
                    <ng-container formArrayName="puntosIntermedios">
                      <ng-container *ngFor="let point of puntosIntermedios.controls; let i=index">
                        <ng-container [formGroupName]="i" class="row">

                          <mat-form-field>
                            <input matInput placeholder="Nombre punto {{i+1}}" formControlName="Nombre" (keyup)="removeCoors('Coors',i)">
                            <!-- (keyup)="removeCoors('Coors',i)" -->
                            <span matPrefix>
                              <mat-icon>location_on</mat-icon>
                            </span>
                            <!-- <span matSuffix>{{puntosIntermedios.at(i).get('Coors').value}}</span> -->
                            <mat-error>
                              Campo
                              <strong>Obligatorio</strong>
                            </mat-error>
                          </mat-form-field>
                          <div>
                            <mat-checkbox formControlName="Vuelta" *ngIf="i > 0">
                              <mat-icon>refresh</mat-icon>
                              ¿Es Ida y Vuelta?
                            </mat-checkbox>
                          </div>

                          <mat-form-field *ngIf="point.get('PuntoAVolver')">
                            <mat-select placeholder="Seleccione Punto a Volver" formControlName="PuntoAVolver">
                              <ng-container *ngFor="let _poin of puntosIntermedios.value; let _i = index">
                                <mat-option *ngIf="_i < i" [value]="_i">
                                  Punto {{ _i + 1 }}
                                </mat-option>
                              </ng-container>
                            </mat-select>
                            <mat-error>
                              Campo
                              <strong>Obligatorio</strong>
                            </mat-error>
                          </mat-form-field>
                          <!-- <mat-form-field>
                                    <input matInput placeholder="Coors punto {{i+1}}" formControlName="Coors" readonly>
                                  </mat-form-field> -->
                          <div class="text-right" *ngIf="puntosIntermedios.length > 2">
                            <button class="remove-point-button" mat-button color="warn" (click)="removeIntermediatePoint(i)">
                              <mat-icon>remove</mat-icon>
                            </button>
                          </div>
                          <div class="col-sm-6">
                            <mat-form-field>
                              <textarea matInput placeholder="Informacion Extra Punto {{i+1}}" formControlName="InformacionExtra"></textarea>
                              <span matPrefix>
                                <mat-icon>short_text</mat-icon>
                              </span>
                              <mat-error>
                                Campo
                                <strong>Obligatorio</strong>
                              </mat-error>
                            </mat-form-field>
                          </div>
                          <div class="col-sm-6">
                            <mat-form-field>
                              <textarea matInput placeholder="Que Debe Hacer Punto {{i+1}}" formControlName="QueDebeHacer"></textarea>
                              <span matPrefix>
                                <mat-icon>create</mat-icon>
                              </span>
                              <mat-error>
                                Campo
                                <strong>Obligatorio</strong>
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                    <div class="text-right">
                      <button mat-mini-fab (click)="addIntermediatePoint()">
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                    <div class="text-center">
                      <button matStepperNext type="submit" class="btn btn-primary" color="primary">Siguiente</button>
                    </div>
                  </form>
                  
                </mat-step>

                <!-- Details -->
                
                <mat-step [completed]="isValidDetails" [editable]="isStepEditable">
                  <ng-template matStepLabel>Detalles</ng-template>
                  <app-mensajeria-form-details (onEdit)="onEditDetails($event)"></app-mensajeria-form-details>
                  <div class="text-center">
                    <button matStepperNext type="submit" class="btn btn-primary" color="primary">Siguiente</button>
                  </div>
                </mat-step>
                
                <!-- Cotizacion -->
                <mat-step [editable]="isStepEditable" [completed]="isQuoteCompleted">
                  <ng-template matStepLabel>Cotización</ng-template>

                  <!-- Spinner Quoting -->
                  <ng-container *ngIf="isQuoting">
                    <div class="text-center">
                      <mat-spinner></mat-spinner>
                      <h4>Realizando Cotizacion
                        <small>Espere porfavor</small>
                      </h4>
                    </div>
                  </ng-container>

                  <!-- Quote Details -->
                  <ng-container *ngIf="!isQuoting && isQuoteCompleted; else noQuoteCompleted">
                    <mat-list>
                      <h3 mat-subheader>Resumen del servicio</h3>
                      <mat-list-item>
                        <mat-icon mat-list-icon>location_on</mat-icon>
                        <h4 mat-line>Distancia Total: </h4>
                        <h6 mat-line>
                          <strong>{{(Servicio.DistanciaTotal / 1000) | number:'1.0'}} Km</strong>
                        </h6>
                        <p mat-line> </p>
                      </mat-list-item>

                      <mat-list-item>
                        <mat-icon mat-list-icon>access_time</mat-icon>
                        <h4 mat-line>Tiempo Espera</h4>
                        <h6 mat-line>
                          <strong>{{ Servicio.TiempoEspera | number }}</strong>
                        </h6>
                        <p mat-line class="note">(Nota: El total del servicio está sujeto a cambio según el tiempo de espera en cada parada)</p>
                      </mat-list-item>

                      <mat-list-item>
                        <mat-icon mat-list-icon>timer</mat-icon>
                        <h4 mat-line>Duración Aproximada: </h4>
                        <h6 mat-line>
                          <strong>{{(Servicio.DuracionTotal) | number}} Minutos</strong>
                        </h6>
                        <p mat-line>Más el tiempo de tome cada parada.</p>
                      </mat-list-item>

                      <mat-list-item>
                        <mat-icon mat-list-icon>timeline</mat-icon>
                        <h4 mat-line>Total Puntos a Recorrer: </h4>
                        <h6 mat-line>
                          <strong>{{Servicio.Recorrido.length}} Puntos</strong>
                        </h6>
                        <p mat-line></p>
                      </mat-list-item>
       
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Sobrecosto por Servicio fuera de la ciudad: </h4>
                        <h6 mat-line>
                          <strong>$ {{Servicio.SobreCostoFueraCiudad | number }}</strong>
                        </h6>
                        <p mat-line></p>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Valor Base</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.ValorBase | number }}</strong>
                        </h6>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Recargo Paradas</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.RecargoParadas | number }}</strong>
                        </h6>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Recargo Km. Adicional</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.RecargoKmAdi | number }}</strong>
                        </h6>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Descuento por Bono de Descuento</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.TotalDescuento | number }}</strong>
                        </h6>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Valor Asegurado</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.ValorAsegurado | number }}</strong>
                        </h6>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon mat-list-icon>attach_money</mat-icon>
                        <h4 mat-line>Seguro A Pagar</h4>
                        <h6 mat-line>
                          <strong>$ {{ Servicio.SeguroAPagar | number }}</strong>
                        </h6>
                        <p mat-line class="note">(Nota: Para valores declarados desde $0 hasta $500.000 el seguro es sin costo. Para valores desde
                          $500.001 hasta $2.000.000 el costo es del 2% sobre el valor asegurado)</p>
                      </mat-list-item>
                      <mat-list-item class="total-amount">
                        <mat-icon mat-list-icon>monetization_on</mat-icon>
                        <h4 mat-line>Total a pagar:
                          <strong>$ {{(Servicio.TotalAPagar) | number}}</strong>
                        </h4>
                        <p mat-line>Pesos Colombianos.</p>
                      </mat-list-item>
                      <mat-divider></mat-divider>
                      <h3 mat-subheader>Resumen del recorrido</h3>
                      <mat-list-item *ngFor="let point of TravelSummary; let i=index">

                        <mat-icon mat-list-icon>location_on</mat-icon>
                        <div [ngSwitch]="i">
                          <h4 matLine *ngSwitchCase="0">Dirección de Partida</h4>
                          <h4 matLine *ngSwitchCase="TravelSummary.length-1">Dirección de Entrega</h4>
                          <h4 matLine *ngSwitchDefault>Punto Intermedio</h4>
                        </div>
                        <h4 mat-line>
                          <strong>Ubicación {{i+1}}</strong>
                        </h4>
                        <p mat-line>{{point.Nombre}}</p>
                        <h4 mat-line>
                          <strong>Informacion Extra</strong>
                        </h4>
                        <p mat-line>{{point.InformacionExtra}}</p>
                        <h4 mat-line>
                          <strong>¿Que Debo Hacer?</strong>
                        </h4>
                        <p mat-line>{{point.QueDebeHacer}}</p>
                      </mat-list-item>
                    </mat-list>
                    <div class="text-center">
                      <button class="btn btn-primary" color="primary" matStepperNext>
                        Realizar Solicitud
                      </button>
                    </div>
                  </ng-container>

                  <ng-template #noQuoteCompleted *ngIf="!isQuoting">
                    <div class="text-center">
                      <h3 class="h3">Hubo un Error
                        <small>Error en la Cotización</small>
                      </h3>
                    </div>
                    <mat-divider></mat-divider>
                    <div>
                      Lo sentimos, el sistema tuvo un error calculando la Cotización para su servicio. Le ofrecemos disculpas, por favor vuelva
                      al paso anterior e intentelo de nuevo.
                    </div>
                  </ng-template>

                  <div class="text-left">
                    <button mat-button matStepperPrevious>
                      <mat-icon>arrow_back</mat-icon>
                    </button>
                  </div>
                </mat-step>

                <mat-step [editable]="isStepEditable">
                    <ng-template matStepLabel>Solicitar</ng-template>
                  <div class="text-center" *ngIf="isSaving$ | async"> 
                    <mat-spinner></mat-spinner>
                  </div>
                  <div [innerHTML]="messageSaved"></div>
                </mat-step>
              </mat-horizontal-stepper>
            </mat-card>
          </div>
        </div>
      </div>

    </ng-container>

  </ng-container>

</div>

<ng-template #noSelectedCity>
  <P>Debes seleccionar una ciudad</P>
</ng-template>

<ng-template #noCoordenadas>
  <div class="text-center">
    <h3 class="h3">
      No Hay Coordenadas Especificadas
      <small>No Puede Cargarse el mapa</small>
    </h3>
    <mat-divider></mat-divider>
    <p>Por favor, comunicarse con administración.</p>
  </div>
</ng-template>

<ng-template #noTarifas>
  <div class="text-center">
    <h3 class="h3">
      No Hay Tarifas para la ciudad Especificadas
      <small>No es posible hacer la solicitud</small>
    </h3>
    <mat-divider></mat-divider>
    <p>Por favor, intente con otra ciudad o comuniquese con administración.</p>
  </div>
</ng-template>

<spinner></spinner>
<!-- 
<pre class="code-panel" *ngIf="form">
  {{ form.value | json }}
</pre> -->